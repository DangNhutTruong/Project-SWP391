import React, { useState, useEffect, useRef } from "react";
import { FaTrophy, FaShare, FaFacebook, FaTwitter, FaCopy, FaTimes } from "react-icons/fa";
import "../styles/Achievement.css";

const Achievement = ({ achievements, title = "Huy hi·ªáu ƒë√£ ƒë·∫°t", showViewAll = true }) => {
  const [showShareMenu, setShowShareMenu] = useState(null);
  const [shareStatus, setShareStatus] = useState({ show: false, message: '' });
  const [showAllAchievements, setShowAllAchievements] = useState(false);
  const [displayedAchievements, setDisplayedAchievements] = useState(achievements);
  
  const shareMenuRef = useRef(null);
  
  // C·∫≠p nh·∫≠t danh s√°ch huy hi·ªáu hi·ªÉn th·ªã khi c√≥ thay ƒë·ªïi
  useEffect(() => {
    setDisplayedAchievements(achievements);
  }, [achievements]);
  
  // ƒê√≥ng menu share khi nh·∫•n ra ngo√†i
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (shareMenuRef.current && !shareMenuRef.current.contains(event.target)) {
        setShowShareMenu(null);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, []);
  
  // ƒê√≥ng th√¥ng b√°o chia s·∫ª sau 3 gi√¢y
  useEffect(() => {
    if (shareStatus.show) {
      const timer = setTimeout(() => {
        setShareStatus({ show: false, message: '' });
      }, 3000);
      
      return () => clearTimeout(timer);
    }
  }, [shareStatus]);
  
  // Hi·ªÉn th·ªã th√¥ng b√°o chia s·∫ª th√†nh c√¥ng
  const showShareNotification = (message) => {
    setShareStatus({
      show: true,
      message: message
    });
  };
  
  // H√†m ƒë·ªÉ chia s·∫ª huy hi·ªáu ƒë·∫°t ƒë∆∞·ª£c
  const handleShareAchievement = (achievement, platform = null) => {
    // ƒê√≥ng menu chia s·∫ª
    setShowShareMenu(null);
    
    // T·∫°o n·ªôi dung chia s·∫ª
    const shareContent = `
üèÜ T√¥i ƒë√£ ƒë·∫°t ƒë∆∞·ª£c huy hi·ªáu "${achievement.name}" trong h√†nh tr√¨nh cai thu·ªëc l√°!
üìÖ Ng√†y ƒë·∫°t ƒë∆∞·ª£c: ${achievement.date}
üí™ H√£y tham gia c√πng t√¥i trong h√†nh tr√¨nh h∆∞·ªõng t·ªõi m·ªôt cu·ªôc s·ªëng kh·ªèe m·∫°nh h∆°n!
    `;
    
    // X·ª≠ l√Ω chia s·∫ª d·ª±a tr√™n n·ªÅn t·∫£ng ƒë∆∞·ª£c ch·ªçn
    if (platform === 'facebook') {
      const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(shareContent)}`;
      window.open(facebookUrl, '_blank');
      showShareNotification('ƒê√£ m·ªü c·ª≠a s·ªï chia s·∫ª Facebook');
    } 
    else if (platform === 'twitter') {
      const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareContent)}`;
      window.open(twitterUrl, '_blank');
      showShareNotification('ƒê√£ m·ªü c·ª≠a s·ªï chia s·∫ª Twitter');
    }
    else if (platform === 'copy') {
      try {
        navigator.clipboard.writeText(shareContent);
        showShareNotification('ƒê√£ sao ch√©p th√¥ng tin huy hi·ªáu!');
      } catch (err) {
        console.log('L·ªói khi sao ch√©p v√†o clipboard:', err);
        showShareNotification('Kh√¥ng th·ªÉ sao ch√©p t·ª± ƒë·ªông.');
      }
    }
    else if (platform === null && navigator.share) {
      // S·ª≠ d·ª•ng Web Share API n·∫øu c√≥ s·∫µn
      navigator.share({
        title: `Huy hi·ªáu: ${achievement.name}`,
        text: shareContent,
      })
      .then(() => showShareNotification('ƒê√£ chia s·∫ª th√†nh c√¥ng!'))
      .catch((error) => {
        console.log('L·ªói khi chia s·∫ª:', error);
        showShareNotification('Kh√¥ng th·ªÉ chia s·∫ª. Vui l√≤ng th·ª≠ l·∫°i.');
      });
    } 
    else if (platform === null) {
      // Fallback cho c√°c tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Share API
      // Hi·ªÉn th·ªã menu chia s·∫ª t√πy ch·ªânh
      setShowShareMenu(achievement.id);
    }
  };

  // ƒê√≥ng menu chia s·∫ª
  const closeShareMenu = (e) => {
    e.stopPropagation();
    setShowShareMenu(null);
  };
  
  // X·ª≠ l√Ω hi·ªÉn th·ªã t·∫•t c·∫£ huy hi·ªáu
  const handleViewAllAchievements = () => {
    // M·ªü modal hi·ªÉn th·ªã t·∫•t c·∫£ huy hi·ªáu
    setShowAllAchievements(true);
  };

  return (    
    <div className="achievements-section">
      <h1 style={{ color: "#333", fontWeight: "700" }}>{title}</h1>

      {shareStatus.show && (
        <div className="share-notification">
          <p>{shareStatus.message}</p>
        </div>
      )}

      <div className="achievements-grid">
        {displayedAchievements.map((achievement) => (
          <div
            key={achievement.id}
            className={`achievement-card ${
              !achievement.date ? "locked" : ""
            }`}
          >
            <div className="achievement-icon">{achievement.icon}</div>
            <h3>{achievement.name}</h3>
            <p>{achievement.date || "ƒê·∫°t khi ƒë·ªß ƒëi·ªÅu ki·ªán"}</p>
            
            {achievement.date && (
              <div className="share-container">
                <button 
                  className="share-achievement-btn"
                  onClick={() => handleShareAchievement(achievement)}
                >
                  <FaShare /> Chia s·∫ª
                </button>
                
                {showShareMenu === achievement.id && (
                  <div className="share-menu" ref={shareMenuRef}>
                    <button className="close-share-menu" onClick={closeShareMenu}>
                      <FaTimes />
                    </button>
                    <h4>Chia s·∫ª huy hi·ªáu</h4>
                    <button 
                      className="share-option" 
                      onClick={() => handleShareAchievement(achievement, 'facebook')}
                    >
                      <FaFacebook className="facebook-icon" /> Facebook
                    </button>
                    <button 
                      className="share-option" 
                      onClick={() => handleShareAchievement(achievement, 'twitter')}
                    >
                      <FaTwitter className="twitter-icon" /> Twitter
                    </button>
                    <button 
                      className="share-option" 
                      onClick={() => handleShareAchievement(achievement, 'copy')}
                    >
                      <FaCopy /> Sao ch√©p li√™n k·∫øt
                    </button>
                  </div>
                )}
              </div>
            )}
          </div>
        ))}
      </div>

      {showViewAll && (
        <h2 
          style={{ color: '#2570e8', cursor: 'pointer' }}
          onClick={handleViewAllAchievements}
        >
          Xem t·∫•t c·∫£ huy hi·ªáu
        </h2>
      )}
      
      {/* Modal hi·ªÉn th·ªã t·∫•t c·∫£ huy hi·ªáu */}
      {showAllAchievements && (
        <div className="all-achievements-modal">
          <div className="all-achievements-content">
            <button 
              className="close-all-achievements" 
              onClick={() => setShowAllAchievements(false)}
            >
              <FaTimes />
            </button>
            <h2>T·∫•t c·∫£ huy hi·ªáu</h2>
            
            <div className="all-achievements-grid">
              {/* Huy hi·ªáu th·ªùi gian */}
              <div className="achievement-category">
                <h3>Th·ªùi gian cai thu·ªëc</h3>
                <div className="category-achievements">
                  <div className="achievement-card">
                    <div className="achievement-icon">‚≠ê</div>
                    <h3>24 gi·ªù ƒë·∫ßu ti√™n</h3>
                    <p>Kh√¥ng h√∫t thu·ªëc trong 24 gi·ªù ƒë·∫ßu ti√™n</p>
                  </div>
                  <div className="achievement-card">
                    <div className="achievement-icon">üèÖ</div>
                    <h3>1 tu·∫ßn kh√¥ng h√∫t</h3>
                    <p>ƒê·∫°t m·ªëc 1 tu·∫ßn kh√¥ng h√∫t thu·ªëc</p>
                  </div>
                  <div className="achievement-card">
                    <div className="achievement-icon">üèÜ</div>
                    <h3>2 tu·∫ßn kh√¥ng h√∫t</h3>
                    <p>ƒê·∫°t m·ªëc 2 tu·∫ßn kh√¥ng h√∫t thu·ªëc</p>
                  </div>
                  <div className="achievement-card">
                    <div className="achievement-icon">üëë</div>
                    <h3>1 th√°ng kh√¥ng h√∫t</h3>
                    <p>ƒê·∫°t m·ªëc 1 th√°ng kh√¥ng h√∫t thu·ªëc</p>
                  </div>
                  <div className="achievement-card locked">
                    <div className="achievement-icon">üåü</div>
                    <h3>3 th√°ng kh√¥ng h√∫t</h3>
                    <p>ƒê·∫°t khi ƒë·ªß ƒëi·ªÅu ki·ªán</p>
                  </div>
                  <div className="achievement-card locked">
                    <div className="achievement-icon">üíé</div>
                    <h3>6 th√°ng kh√¥ng h√∫t</h3>
                    <p>ƒê·∫°t khi ƒë·ªß ƒëi·ªÅu ki·ªán</p>
                  </div>
                  <div className="achievement-card locked">
                    <div className="achievement-icon">üîÆ</div>
                    <h3>1 nƒÉm kh√¥ng h√∫t</h3>
                    <p>ƒê·∫°t khi ƒë·ªß ƒëi·ªÅu ki·ªán</p>
                  </div>
                </div>
              </div>
              
              {/* Huy hi·ªáu s·ª©c kh·ªèe */}
              <div className="achievement-category">
                <h3>C·∫£i thi·ªán s·ª©c kh·ªèe</h3>
                <div className="category-achievements">
                  <div className="achievement-card">
                    <div className="achievement-icon">‚ù§Ô∏è</div>
                    <h3>Huy·∫øt √°p ·ªïn ƒë·ªãnh</h3>
                    <p>Huy·∫øt √°p tr·ªü l·∫°i b√¨nh th∆∞·ªùng sau 20 ph√∫t</p>
                  </div>
                  <div className="achievement-card locked">
                    <div className="achievement-icon">ü´Å</div>
                    <h3>Ph·ªïi kh·ªèe m·∫°nh h∆°n</h3>
                    <p>ƒê·∫°t khi ƒë·ªß ƒëi·ªÅu ki·ªán</p>
                  </div>
                  <div className="achievement-card locked">
                    <div className="achievement-icon">üß†</div>
                    <h3>N√£o b·ªô t·ªânh t√°o</h3>
                    <p>ƒê·∫°t khi ƒë·ªß ƒëi·ªÅu ki·ªán</p>
                  </div>
                </div>
              </div>
              
              {/* Huy hi·ªáu t√†i ch√≠nh */}
              <div className="achievement-category">
                <h3>Ti·∫øt ki·ªám t√†i ch√≠nh</h3>
                <div className="category-achievements">
                  <div className="achievement-card locked">
                    <div className="achievement-icon">üí∞</div>
                    <h3>Ti·∫øt ki·ªám 500K</h3>
                    <p>ƒê·∫°t khi ƒë·ªß ƒëi·ªÅu ki·ªán</p>
                  </div>
                  <div className="achievement-card locked">
                    <div className="achievement-icon">üí∏</div>
                    <h3>Ti·∫øt ki·ªám 1 tri·ªáu</h3>
                    <p>ƒê·∫°t khi ƒë·ªß ƒëi·ªÅu ki·ªán</p>
                  </div>
                  <div className="achievement-card locked">
                    <div className="achievement-icon">üè¶</div>
                    <h3>Ti·∫øt ki·ªám 5 tri·ªáu</h3>
                    <p>ƒê·∫°t khi ƒë·ªß ƒëi·ªÅu ki·ªán</p>
                  </div>
                </div>
              </div>
              
              {/* Huy hi·ªáu ƒë·∫∑c bi·ªát */}
              <div className="achievement-category">
                <h3>Th√†nh t·ª±u ƒë·∫∑c bi·ªát</h3>
                <div className="category-achievements">
                  <div className="achievement-card locked">
                    <div className="achievement-icon">üî•</div>
                    <h3>V∆∞·ª£t qua c√°m d·ªó</h3>
                    <p>ƒê·∫°t khi ƒë·ªß ƒëi·ªÅu ki·ªán</p>
                  </div>
                  <div className="achievement-card locked">
                    <div className="achievement-icon">üå±</div>
                    <h3>Th√≥i quen m·ªõi</h3>
                    <p>ƒê·∫°t khi ƒë·ªß ƒëi·ªÅu ki·ªán</p>
                  </div>
                  <div className="achievement-card locked">
                    <div className="achievement-icon">ü§ù</div>
                    <h3>Ng∆∞·ªùi truy·ªÅn c·∫£m h·ª©ng</h3>
                    <p>ƒê·∫°t khi ƒë·ªß ƒëi·ªÅu ki·ªán</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default Achievement;
